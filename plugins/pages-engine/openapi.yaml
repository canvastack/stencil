openapi: 3.1.0
info:
  title: CanvaStencil Pages Engine API
  description: |
    WordPress-like CMS Pages System API for blog, news, events, and custom content types with 
    hierarchical categories, comment system, and SEO optimization.
    
    ## Authentication
    All admin and platform endpoints require authentication via Laravel Sanctum bearer tokens.
    
    ## Multi-tenancy
    All endpoints automatically scope data to the authenticated user's tenant context.
    
    ## UUID-Only Exposure
    All public IDs are UUIDs. Integer database IDs are never exposed in API responses.
  version: 1.0.0
  contact:
    name: CanvaStack Team
    email: support@canvastack.com

servers:
  - url: http://localhost:8000/api
    description: Local Development
  - url: https://api.canvastack.com/api
    description: Production

tags:
  - name: Admin - Content Types
    description: Content type management endpoints for tenant administrators
  - name: Admin - Contents
    description: Content CRUD and publishing workflow for tenant administrators
  - name: Admin - Categories
    description: Category management with hierarchical support
  - name: Admin - Comments
    description: Comment moderation and management
  - name: Admin - Revisions
    description: Content revision history and restore
  - name: Admin - URLs
    description: URL generation and preview
  - name: Public - Contents
    description: Public-facing content browsing and search
  - name: Public - Comments
    description: Public comment submission and replies
  - name: Public - Categories
    description: Public category browsing
  - name: Platform - Content Types
    description: Platform-wide content type management

paths:
  /cms/health:
    get:
      summary: Health Check
      description: Check if the CMS plugin is active and operational
      tags: [Health]
      responses:
        '200':
          description: Plugin is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  plugin:
                    type: string
                    example: pages-engine
                  version:
                    type: string
                    example: 1.0.0
                  status:
                    type: string
                    example: active

  /cms/admin/content-types:
    get:
      summary: List Content Types
      description: Retrieve paginated list of content types with filtering
      tags: [Admin - Content Types]
      security:
        - bearerAuth: []
      parameters:
        - name: scope
          in: query
          schema:
            type: string
            enum: [all, platform, tenant]
            default: all
        - name: is_active
          in: query
          schema:
            type: boolean
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 15
            maximum: 100
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentTypeListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Create Content Type
      description: Create a new content type
      tags: [Admin - Content Types]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateContentTypeRequest'
      responses:
        '201':
          description: Content type created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentTypeResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/ValidationError'

  /cms/admin/content-types/{uuid}:
    get:
      summary: Show Content Type
      description: Retrieve a single content type by UUID
      tags: [Admin - Content Types]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UuidPath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentTypeResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update Content Type
      description: Update an existing content type
      tags: [Admin - Content Types]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UuidPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateContentTypeRequest'
      responses:
        '200':
          description: Content type updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentTypeResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'

    delete:
      summary: Delete Content Type
      description: Delete a content type (must not have associated contents)
      tags: [Admin - Content Types]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UuidPath'
      responses:
        '200':
          description: Content type deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '422':
          description: Content type is in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /cms/public/comments:
    post:
      summary: Submit Comment
      description: Submit a new comment on published content (guest or authenticated)
      tags: [Public - Comments]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitCommentRequest'
      responses:
        '201':
          description: Comment submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentResponse'
        '422':
          $ref: '#/components/responses/ValidationError'

  /cms/public/comments/{parentUuid}/reply:
    post:
      summary: Reply to Comment
      description: Submit a reply to an existing comment
      tags: [Public - Comments]
      parameters:
        - name: parentUuid
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitCommentRequest'
      responses:
        '201':
          description: Reply submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentResponse'
        '422':
          $ref: '#/components/responses/ValidationError'

  /cms/public/categories:
    get:
      summary: List Categories
      description: Retrieve active categories with optional filtering
      tags: [Public - Categories]
      parameters:
        - name: content_type
          in: query
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryListResponse'

  /cms/public/categories/tree:
    get:
      summary: Get Category Tree
      description: Retrieve hierarchical category tree
      tags: [Public - Categories]
      parameters:
        - name: content_type
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CategoryTree'

  /cms/public/categories/{slug}:
    get:
      summary: Show Category by Slug
      description: Retrieve a category by its slug
      tags: [Public - Categories]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryResponse'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    UuidPath:
      name: uuid
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    ContentType:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
          nullable: true
        icon:
          type: string
          nullable: true
        default_url_pattern:
          type: string
          nullable: true
        scope:
          type: string
          enum: [platform, tenant]
        is_active:
          type: boolean
        is_commentable:
          type: boolean
        is_categorizable:
          type: boolean
        is_taggable:
          type: boolean
        is_revisioned:
          type: boolean
        metadata:
          type: object
          nullable: true
        contents_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateContentTypeRequest:
      type: object
      required:
        - name
        - slug
      properties:
        name:
          type: string
          maxLength: 255
        slug:
          type: string
          pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$'
        description:
          type: string
          maxLength: 1000
        icon:
          type: string
          maxLength: 100
        default_url_pattern:
          type: string
          maxLength: 500
        is_commentable:
          type: boolean
          default: false
        is_categorizable:
          type: boolean
          default: true
        is_taggable:
          type: boolean
          default: true
        is_revisioned:
          type: boolean
          default: true
        metadata:
          type: object

    UpdateContentTypeRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 255
        description:
          type: string
          maxLength: 1000
        icon:
          type: string
          maxLength: 100
        default_url_pattern:
          type: string
          maxLength: 500
        is_commentable:
          type: boolean
        is_categorizable:
          type: boolean
        is_taggable:
          type: boolean
        is_revisioned:
          type: boolean
        metadata:
          type: object

    SubmitCommentRequest:
      type: object
      required:
        - content_uuid
        - body
      properties:
        content_uuid:
          type: string
          format: uuid
        body:
          type: string
          minLength: 3
          maxLength: 5000
        parent_uuid:
          type: string
          format: uuid
          nullable: true
        author_name:
          type: string
          maxLength: 255
          description: Required for guest users
        author_email:
          type: string
          format: email
          maxLength: 255
          description: Required for guest users

    Comment:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
        content_uuid:
          type: string
          format: uuid
        author_name:
          type: string
        author_email:
          type: string
          format: email
        body:
          type: string
        status:
          type: string
          enum: [pending, approved, rejected, spam]
        parent_uuid:
          type: string
          format: uuid
          nullable: true
        depth:
          type: integer
        approved_at:
          type: string
          format: date-time
          nullable: true
        replies:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
        created_at:
          type: string
          format: date-time

    Category:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
          nullable: true
        parent_uuid:
          type: string
          format: uuid
          nullable: true
        sort_order:
          type: integer
        metadata:
          type: object
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CategoryTree:
      allOf:
        - $ref: '#/components/schemas/Category'
        - type: object
          properties:
            children:
              type: array
              items:
                $ref: '#/components/schemas/CategoryTree'

    ContentTypeListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/ContentType'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    ContentTypeResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/ContentType'
        message:
          type: string

    CommentResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Comment'
        message:
          type: string

    CategoryListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    CategoryResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Category'

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object

    ValidationErrorResponse:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

    PaginationMeta:
      type: object
      properties:
        current_page:
          type: integer
        from:
          type: integer
          nullable: true
        last_page:
          type: integer
        per_page:
          type: integer
        to:
          type: integer
          nullable: true
        total:
          type: integer

  responses:
    Unauthorized:
      description: Unauthorized - Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationErrorResponse'
