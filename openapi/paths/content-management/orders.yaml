# TENANT ENDPOINTS ONLY - Orders are tenant business operations
# Platform does NOT handle tenant business operations

# Customer-facing order creation (public endpoint)
/tenant/orders:
  post:
    tags:
    - Customer Orders
    summary: Create New Order
    description: 'Create a new order from customer (walk-in, phone, or website).

      **Business Workflow** (per PHASE_4_B):
      1. Customer submits order via website, phone, or walk-in (admin can input)
      2. System generates unique order code (ORD-YYYY-MM-NNNN) with tenant scoping
      3. Order status initialized to "new" with automatic timestamp
      4. Automatic notification sent to admin team and assigned users
      5. Production type determined based on product specifications (vendor vs internal)
      6. Order enters into quotation/negotiation workflow with vendor

      **Features:**
      - Multi-item orders with individual customization details
      - Design file upload support for specification documentation
      - Automatic customer validation and duplicate checking
      - Tenant-scoped order numbering (sequential per tenant)
      - Real-time inventory checking (if applicable)
      - Customization metadata storage (materials, sizes, colors, text placement)
      - Priority level assignment (normal, high, urgent)
      '
    operationId: createOrder
    security: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../../components/schemas.yaml#/CreateOrderRequest'
          examples:
            etching_order:
              summary: Etching order with customization
              value:
                customer:
                  name: Budi Santoso
                  email: budi@example.com
                  phone: '+628123456789'
                  company: PT Example Indonesia
                  type: business
                items:
                - product_name: Custom Etched Brass Plate
                  quantity: 5
                  customization:
                    bahan: Kuningan
                    kualitas: premium
                    ketebalan: 2mm
                    ukuran: 30cm x 20cm
                    warna_background: '#FFFFFF'
                    custom_text: Best Employee 2025
                    custom_text_placement: center
                  design_file_url: https://storage.example.com/designs/logo.png
                shipping_address:
                  address: Jl. Sudirman No. 123, Blok A-5
                  city: Jakarta Pusat
                  province: DKI Jakarta
                  postal_code: '10110'
                  country: Indonesia
                customer_notes: Please pack carefully for corporate event
                priority: normal
    responses:
      '201':
        description: Order created successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PurchaseOrder'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'
  get:
    tags:
    - Orders Management
    summary: List All Orders (Tenant)
    description: 'Retrieve paginated list of all orders with comprehensive filtering and search.

      **Admin Features** (per PHASE_4_B order management):
      - Multi-status filtering (new, confirmed, quoted, production, shipped, delivered, cancelled, on_hold)
      - Date range filtering for order lifecycle analysis
      - Customer and vendor filtering for operational segregation
      - Payment status filtering (unpaid, partial, verified, pending)
      - Production type filtering (vendor vs internal)
      - Full-text search across order codes, customer names, emails, phone
      - Advanced sorting options (date, status, priority, amount)
      - Real-time statistics and aggregation

      **Performance Optimization:**
      - Optimized queries with tenant-aware indexing
      - Pagination for large datasets
      - Efficient status aggregation and counters
      - Cache-friendly response structures
      '
    operationId: listOrders
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: status
      in: query
      schema:
        type: array
        items:
          type: string
      style: form
      explode: false
      description: Filter by order status
    - name: payment_status
      in: query
      schema:
        type: array
        items:
          type: string
      style: form
      explode: false
      description: Filter by payment status
    - name: production_type
      in: query
      schema:
        type: string
        enum:
        - internal
        - vendor
      description: Filter by production type
    - name: customer_id
      in: query
      schema:
        type: string
        format: uuid
      description: Filter by specific customer
    - name: vendor_id
      in: query
      schema:
        type: string
        format: uuid
      description: Filter by specific vendor
    - name: date_from
      in: query
      schema:
        type: string
        format: date
      description: Orders from date (YYYY-MM-DD)
    - name: date_to
      in: query
      schema:
        type: string
        format: date
      description: Orders to date (YYYY-MM-DD)
    - name: search
      in: query
      schema:
        type: string
      description: Search order code, customer name, email, phone
    - name: priority
      in: query
      schema:
        type: array
        items:
          type: string
      style: form
      explode: false
      description: Filter by order priority
    - $ref: '../../components/schemas.yaml#/PageParam'
    - $ref: '../../components/schemas.yaml#/PerPageParam'
    - $ref: '../../components/schemas.yaml#/SortParam'
    - $ref: '../../components/schemas.yaml#/OrderParam'
    responses:
      '200':
        description: Orders list retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrdersPageData'
                  meta:
                    $ref: '../../components/schemas.yaml#/PaginationMeta'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'

# Public order status checking (no authentication required)
/tenant/orders/{order_code}/status:
  get:
    tags:
    - Public Order Status
    summary: Check Order Status (Public)
    description: 'Public endpoint for customers to check order status using order code.

      **Public Access:**
      - No authentication required
      - Limited information disclosure
      - Customer-safe data only
      - Status tracking for transparency
      '
    operationId: checkOrderStatus
    security: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: order_code
      in: path
      required: true
      schema:
        type: string
        pattern: '^ORD-\d{4}-\d{2}-\d{4}$'
      description: Order code (e.g., ORD-2025-01-0001)
    responses:
      '200':
        description: Order status retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PublicOrderStatus'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Admin order management endpoints
/tenant/orders/{id}:
  get:
    tags:
    - Orders Management
    summary: Get Order Details (Complete Order Profile)
    description: 'Retrieve complete order details including all related data for comprehensive order management.

      **Complete Order Profile** (per PHASE_4_B order lifecycle):
      - **Core Order Data**: Order code, status, priority, customer contact info, shipping address
      - **Order Items**: All items with customization details, design files, specifications
      - **Quotation Workflow**: Vendor quotations, customer quotations with markup calculations, revisions history
      - **Negotiation Track**: Multi-round vendor negotiations, counter-offers, final agreed pricing
      - **Payment Records**: All payments (DP/partial/full), verification status, proof of payment
      - **Shipment Tracking**: Shipping method, tracking numbers, delivery status, POD documents
      - **Production Status**: Current production stage, vendor progress reports, quality checkpoints
      - **Status History**: Complete audit trail with timestamps and user actions
      - **Profitability**: Vendor cost vs customer price, markup calculations, profit margins
      - **Communication Logs**: All omni-channel communications (email, WhatsApp, SMS, internal notes)
      - **SLA Compliance**: Delivery deadlines, milestone dates, breach risk assessment
      '
    operationId: getOrderDetails
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: Order details retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderDetail'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  put:
    tags:
    - Orders Management
    summary: Update Order
    description: 'Update order information (limited fields for data integrity).

      **Updateable Fields:**
      - Customer contact information
      - Shipping/billing addresses
      - Customer notes and internal notes
      - Priority level
      - Tags and metadata

      **Business Rules:**
      - Cannot update after production starts
      - Status-dependent field restrictions
      - Automatic audit trail creation
      '
    operationId: updateOrder
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../../components/schemas.yaml#/UpdateOrderRequest'
    responses:
      '200':
        description: Order updated successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PurchaseOrder'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Vendor Assignment - Critical Business Decision Point
/tenant/orders/{id}/assign-vendor:
  post:
    tags:
    - Orders Management
    summary: Assign Vendor to Order (Production Decision)
    description: 'Assign vendor for production - critical decision point in order lifecycle per PHASE_4_B.

      **Business Context** (per BUSINESS_CYCLE_PLAN):
      - After order confirmation, this is the primary decision: vendor or internal production
      - Admin reviews order requirements and selects appropriate vendor
      - System automatically triggers vendor quotation request workflow
      - Triggers email notification to vendor with production proposal
      - Initiates price negotiation process if enabled

      **Vendor Selection Logic:**
      - **Automatic Suggestions** based on:
        - Material specializations and expertise
        - Quality tier requirements matching order specs
        - Historical performance ratings and ratings
        - Lead time capacity and availability
        - Geographic proximity for shipping optimization
      - **Manual Override**: Admin can select any vendor regardless of automatic suggestions
      - **Vendor Availability Checking**: Verify vendor capacity before assignment
      - **Auto-Negotiate Option**: Automatically start price negotiation immediately after assignment
      '
    operationId: assignVendor
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - vendor_id
            properties:
              vendor_id:
                type: string
                format: uuid
                description: Selected vendor ID
              production_type:
                type: string
                enum:
                - vendor
                - internal
                default: vendor
                description: Production method
              notes:
                type: string
                description: Assignment notes
              auto_start_negotiation:
                type: boolean
                default: true
                description: Automatically start price negotiation
    responses:
      '200':
        description: Vendor assigned successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      order_id:
                        type: string
                        format: uuid
                      vendor_id:
                        type: string
                        format: uuid
                      vendor_name:
                        type: string
                      assigned_at:
                        type: string
                        format: date-time
                      status:
                        type: string
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Order Status Updates - State Machine Engine
/tenant/orders/{id}/status:
  patch:
    tags:
    - Orders Management
    summary: Update Order Status (State Machine)
    description: 'Update order status with complete business workflow validation per PHASE_4_B state machine.

      **Status Workflow** (per BUSINESS_CYCLE_PLAN complete order lifecycle):
      - **new** → Initial state after order creation
      - **confirmed** → Customer confirmed order after initial contact/negotiation
      - **vendor_assigned** → Vendor selected for production
      - **quoted** → Quotations received from vendor, awaiting customer approval
      - **production** → Production starts (DP or full payment verified)
      - **quality_check** → Quality assurance checkpoint
      - **ready** → Order ready for shipment
      - **shipped** → Shipped to customer with tracking
      - **delivered** → Delivered and received by customer (final status)
      - **cancelled** → Cancelled (allowed from any status except delivered)
      - **on_hold** → Temporary suspension (allowed from most statuses)

      **Automatic Triggers** on status change:
      - **Payment verification**: Check DP/full payment when moving to production
      - **Vendor notifications**: Auto-notify vendor of status changes
      - **Customer notifications**: Auto-notify customer of progress
      - **Accounting updates**: Record financial impacts
      - **SLA monitoring**: Track milestone deadlines
      - **Profitability snapshots**: Record cost/revenue at key stages
      
      **Validation Rules:**
      - Cannot move backward in normal flow (except on_hold)
      - Cannot complete without verified payment (unless custom terms)
      - Cannot cancel after delivery
      - Transitions must follow business rules per status
      '
    operationId: updateOrderStatus
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - status
            properties:
              status:
                type: string
                enum:
                - new
                - confirmed
                - vendor_assigned
                - quoted
                - production
                - quality_check
                - ready
                - shipped
                - delivered
                - cancelled
                - on_hold
                description: New order status
              notes:
                type: string
                description: Status change notes
              notify_customer:
                type: boolean
                default: true
                description: Send notification to customer
    responses:
      '200':
        description: Order status updated successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PurchaseOrder'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Communications Management
/tenant/orders/{id}/communications:
  get:
    tags:
    - Orders Management
    summary: List Order Communications
    description: 'Retrieve omni-channel communication history for the order.

      **Channels Covered:**
      - Email notifications with templating
      - WhatsApp enterprise messaging
      - SMS transactional alerts
      - Internal task assignments and notes
      - Webhook callbacks to external CRMs

      **Compliance:**
      - Tenant-scoped delivery policies
      - GDPR/PDPA consent tracking
      - Delivery auditing and failure escalation
      '
    operationId: listOrderCommunications
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    - name: channel
      in: query
      schema:
        type: string
        enum:
        - email
        - whatsapp
        - sms
        - internal
        - webhook
      description: Filter by communication channel
    - name: status
      in: query
      schema:
        type: string
        enum:
        - queued
        - delivered
        - failed
        - read
        - acknowledged
      description: Filter by delivery status
    responses:
      '200':
        description: Communications retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '../../components/schemas.yaml#/OrderCommunication'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  post:
    tags:
    - Orders Management
    summary: Send/Schedule Communication
    description: 'Send or schedule omni-channel communication to customer.

      **Channels Supported:**
      - Email notifications with templating
      - WhatsApp enterprise messaging
      - SMS transactional alerts
      - Webhook callbacks to external systems

      **Features:**
      - Message templating with variable substitution
      - Scheduled delivery at specific time
      - Proof of delivery tracking
      - Compliance with consent policies
      '
    operationId: sendOrderCommunication
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - channel
            - message_type
            properties:
              channel:
                type: string
                enum:
                - email
                - whatsapp
                - sms
                - webhook
                description: Communication channel
              message_type:
                type: string
                enum:
                - status_update
                - reminder
                - invoice
                - receipt
                - custom
                description: Type of message
              template_id:
                type: string
                description: Message template ID (optional, for templated messages)
              subject:
                type: string
                description: Email subject (for email channel)
              message:
                type: string
                description: Message content
              variables:
                type: object
                description: Template variables for substitution
              recipient:
                type: string
                description: Recipient phone/email (defaults to order customer)
              scheduled_at:
                type: string
                format: date-time
                description: Schedule delivery time (optional)
              track_delivery:
                type: boolean
                default: true
                description: Enable delivery tracking
    responses:
      '201':
        description: Communication sent/scheduled successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderCommunication'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# SLA Management - Deadline & Compliance Tracking
/tenant/orders/{id}/sla:
  get:
    tags:
    - Orders Management
    summary: Get Order SLA Status (Service Level Agreement Tracking)
    description: 'Retrieve SLA compliance metrics and breach risk assessment per PHASE_4_B.

      **SLA Metrics & Tracking**:
      - **Delivery Deadline**: 
        - Final customer delivery deadline
        - Calculated from payment verification + vendor lead time
        - Can be overridden by admin (with approval)
      - **Milestone Deadlines**:
        - Production start deadline: h+ days after payment verification
        - Design approval deadline
        - Quality check deadline
        - Packaging deadline
        - Shipment deadline
      - **Current Status**:
        - Days remaining to deadline
        - Completion percentage vs time elapsed
        - On-track / At-risk / Breached status
      - **Breach Risk Assessment**:
        - Risk percentage based on current progress
        - If on-track: Low risk
        - If delays observed: Medium/High risk
        - Escalation rules triggered
      - **Historical Performance**:
        - Past SLA compliance rate
        - Average lead time for similar orders
        - Vendor track record
      - **Auto-Escalation Configuration**:
        - Notify stakeholders X days before deadline
        - Escalate to management Y days before deadline
        - Auto-trigger contingency if breached
      '
    operationId: getOrderSLA
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: SLA status retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderSLA'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  patch:
    tags:
    - Orders Management
    summary: Update Order SLA
    description: 'Override or adjust SLA milestones and deadlines.

      **SLA Adjustments:**
      - Update delivery deadline
      - Adjust milestone deadlines
      - Add SLA notes
      - Automatic escalation policy
      '
    operationId: updateOrderSLA
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              delivery_deadline:
                type: string
                format: date-time
                description: Override delivery deadline
              milestone_deadlines:
                type: object
                description: Override specific milestone deadlines
              escalation_enabled:
                type: boolean
                default: true
                description: Enable automatic SLA escalation
              notes:
                type: string
                description: SLA override notes
    responses:
      '200':
        description: SLA updated successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderSLA'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Quotations Management - Price Negotiation Foundation
/tenant/orders/{id}/quotations:
  get:
    tags:
    - Quotations Management
    summary: List Order Quotations (Pricing Workflow)
    description: 'Retrieve all quotations for specific order per PHASE_4_B quotation workflow.

      **Quotation Types & Workflow**:
      - **Vendor Quotations**: 
        - Created after vendor assignment
        - Contains vendor''s quoted price and lead time
        - May have multiple revisions during negotiation
        - Final approved vendor quote locked before production
      - **Customer Quotations**: 
        - Created from vendor quote with admin markup
        - Admin applies per-piece markup (e.g., vendor $10 → customer $15)
        - Includes admin-configured tax/PPN
        - Presented to customer for final approval
      - **Revision History**: 
        - Track all quotation versions
        - Show price changes and justifications
        - Maintain audit trail for approval
      - **Approval Status**:
        - draft: Quotation being prepared
        - proposed: Sent to customer/vendor awaiting response
        - accepted: Approved by relevant party
        - rejected: Declined (triggers renegotiation)
        - finalized: Locked in for production
      '
    operationId: listOrderQuotations
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    - name: type
      in: query
      schema:
        type: string
        enum:
        - vendor
        - customer
      description: Filter by quotation type
    responses:
      '200':
        description: Quotations retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '../../components/schemas.yaml#/OrderQuotation'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  post:
    tags:
    - Quotations Management
    summary: Create Order Quotation (Pricing Decision)
    description: 'Create new quotation for order - enables price negotiation workflow.

      **Quotation Creation** (per PHASE_4_B):
      - **Vendor Quotation**: 
        - Admin creates from vendor response in negotiation
        - Records vendor''s quoted price, lead time, special terms
        - Can be created as counter-offer during negotiation rounds
      - **Customer Quotation**: 
        - Admin creates from finalized vendor quote
        - Applies admin-configured markup per piece (e.g., 50% markup)
        - Calculates total: (vendor_price × quantity × markup_ratio) + tax
        - Presented to customer for final order confirmation
      - **Automatic Calculations**:
        - Per-piece pricing
        - Total amounts with tax
        - Profit margins (for admin visibility)
        - Remaining payment due (if DP selected)
      - **Version Management**:
        - Each quotation is a version (quota_v1, quota_v2, etc.)
        - Previous versions retained in history
        - Shows price evolution and negotiation rounds
      - **Workflow Integration**:
        - Vendor quote triggers customer quote creation
        - Customer quote requires customer approval before payment
        - Final approved quote locked for production
      '
    operationId: createOrderQuotation
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../../components/schemas.yaml#/CreateQuotationRequest'
    responses:
      '201':
        description: Quotation created successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderQuotation'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Price Negotiations - Dynamic Vendor Engagement
/tenant/orders/{id}/negotiations:
  get:
    tags:
    - Negotiations Management
    summary: List Order Negotiations (Multi-Round Negotiation History)
    description: 'Retrieve all price negotiation rounds for order per PHASE_4_B negotiation workflow.

      **Negotiation Workflow** (per BUSINESS_CYCLE_PLAN):
      - **Multi-Round Process**: Multiple negotiation rounds until agreement reached
      - **Negotiation Rounds**:
        - Round 1: Admin sends initial quote request with budget/target price
        - Vendor Response: Vendor responds with quotation and lead time
        - Round 2+: If price too high, admin sends counter-offer
        - Final: Agreement reached when both parties accept same price
      - **Vendor Responses**: 
        - Quoted price and lead time
        - Special terms or conditions
        - Availability and capacity info
      - **Counter-Offers**: 
        - Admin counter-offers if vendor price exceeds target
        - Admin can negotiate lead time as well
        - Tracks negotiation history and rationale
      - **Email Communication**: 
        - Complete email history of all communications
        - Templates for professional communications
        - Automatic email triggers on negotiation status changes
      - **Final Agreed Pricing**: 
        - Locked price once both parties agree
        - Creates vendor quotation for order
        - Basis for customer quotation with markup
      - **Negotiation Status**: 
        - pending: Awaiting vendor response
        - countered: Admin counter-offer sent
        - accepted: Vendor accepted agreed price
        - finalised: Locked for production
      '
    operationId: listOrderNegotiations
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: Negotiations retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '../../components/schemas.yaml#/OrderNegotiation'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  post:
    tags:
    - Negotiations Management
    summary: Start Price Negotiation (Initial Vendor Contact)
    description: 'Initiate vendor price negotiation process - first vendor contact point per PHASE_4_B.

      **Negotiation Initiation** (per BUSINESS_CYCLE_PLAN):
      - **Vendor Contact**: System sends automatic email to vendor with order requirements
      - **Information Shared**:
        - Order requirements and specifications
        - Item quantities and customization details
        - Target/budget price (if admin sets)
        - Expected lead time
        - Material/quality requirements
      - **Vendor Response**:
        - Vendor provides quoted price (may be higher/lower than target)
        - Vendor provides lead time estimate
        - Special terms or conditions
        - Capacity confirmation
      - **Negotiation Round Tracking**:
        - Round numbers recorded
        - Dates and times tracked
        - Rationale for each counter-offer documented
      - **Counter-Offer Management**:
        - Admin can send counter-offer if price too high
        - Multiple rounds supported until agreement
        - Automatic email triggers for each round
      - **Deadline Setting**:
        - Admin sets vendor response deadline
        - System tracks time remaining
        - Auto-escalation if vendor doesn''t respond
      - **Final Approval**:
        - Once vendor accepts agreed price
        - Negotiation marked as finalized
        - Vendor quotation automatically created
      '
    operationId: startOrderNegotiation
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - vendor_id
            properties:
              vendor_id:
                type: string
                format: uuid
              target_price:
                type: number
                format: decimal
              items:
                type: array
                items:
                  type: object
                  properties:
                    item_id:
                      type: string
                      format: uuid
                    quantity:
                      type: integer
              deadline:
                type: string
                format: date-time
              notes:
                type: string
    responses:
      '201':
        description: Negotiation started successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderNegotiation'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Payments Management - Critical for Production Decision
/tenant/orders/{id}/payments:
  get:
    tags:
    - Payments Management
    summary: List Order Payments (Payment Lifecycle)
    description: 'Retrieve all payments for specific order per PHASE_4_B payment workflow.

      **Payment Information** (per BUSINESS_CYCLE_PLAN):
      - **Payment History**: Complete record of all payment transactions
      - **Verification Status**: Verified, pending, rejected (critical for production start)
      - **Payment Method**: Cash, bank transfer, credit card, e-wallet
      - **Amount Tracking**: Payment amounts, remaining balance, overpayment/refunds
      - **Proof of Payment**: Supporting documents (receipts, transfer confirmations)
      - **Payment Stages**: 
        - DP Payment (min 50% or customer choice of full payment)
        - Remaining payment due after production completion
      - **Payment Timing**: Payment date relative to production start trigger
      - **Account Status**: Account Payable (DP paid) vs Account Receivable (full paid)
      '
    operationId: listOrderPayments
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: Payments retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '../../components/schemas.yaml#/OrderPayment'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  post:
    tags:
    - Payments Management
    summary: Record Order Payment (Admin Entry)
    description: 'Record customer payment for order - triggers accounting and production workflows.

      **Payment Recording** (per PHASE_4_B payment workflow):
      - **Multiple Payment Methods**: Cash, bank transfer, credit card, e-wallet
      - **Flexible Payment Options**: 
        - DP Payment: Min 50% down payment option
        - Full Payment: 100% full payment option
        - Partial Payments: Multiple partial payments allowed
      - **Proof Storage**: Upload and store proof of payment (receipts, bank slips, screenshots)
      - **Auto-Verification Option**: For certain methods (credit card), auto-verify immediately
      - **Manual Verification Queue**: Bank transfers go to verification queue for admin approval
      - **Automatic Triggers** after recording:
        - If DP payment: Change order status to Account Payable, trigger DP to vendor
        - If full payment: Change order status to Account Receivable, trigger immediate vendor payment
        - SLA timer starts after verified payment
        - Production start notification queued (h+ days after payment verification)
      - **Accounting Integration**: Every payment creates accounting entry for reconciliation
      - **Tenant Scoping**: All payments strictly scoped to order tenant
      '
    operationId: recordOrderPayment
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - amount
            - payment_method
            properties:
              amount:
                type: number
                format: decimal
                description: Payment amount
              payment_method:
                type: string
                enum:
                - cash
                - bank_transfer
                - credit_card
                - ewallet
              payment_date:
                type: string
                format: date-time
              bank_transfer_details:
                type: object
                properties:
                  bank_name:
                    type: string
                  account_number:
                    type: string
                  reference:
                    type: string
              proof_of_payment_url:
                type: string
                format: uri
              notes:
                type: string
              auto_verify:
                type: boolean
                default: false
    responses:
      '201':
        description: Payment recorded successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderPayment'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Payment Verification - Critical Workflow Step
/tenant/orders/{id}/payments/{payment_id}/verify:
  post:
    tags:
    - Payments Management
    summary: Verify Payment (Critical Approval Step)
    description: 'Verify/approve customer payment - CRITICAL decision point per PHASE_4_B workflow.

      **Verification Process** (per BUSINESS_CYCLE_PLAN payment verification):
      - **Manual Verification**: For bank transfers, admin manually verifies receipt in bank account
      - **Automatic Verification**: Some payment gateways (credit card) verify automatically
      - **Verification Queue**: Pending payments queued for admin review
      - **Validation Checks**:
        - Amount matching: Received amount matches expected amount
        - Date validation: Payment date within reasonable window
        - Duplicate checking: Ensure payment not already recorded
        - Account reconciliation: Match to actual bank account deposits
      
      **Business Impact** (on successful verification):
      - **Order Status Update**: Changes order to next status (production-ready)
      - **Vendor Payment Trigger**: 
        - If DP: Send vendor DP amount from customer DP (may be less than full DP)
        - If full: Send full vendor amount immediately
      - **Production Start**: Trigger production start notification (after h+ office days)
      - **SLA Activation**: Start SLA milestone timers
      - **Notifications**:
        - Customer: Payment verified, production starting
        - Vendor: Proceed with production (with cost details)
        - Internal: Accounting, warehouse, production teams notified
      - **Accounting Impact**: Record cost vs revenue snapshot
      
      **Verification Statuses**:
      - verified: Payment confirmed and approved
      - rejected: Payment invalid or duplicate
      - pending: Awaiting manual verification
      '
    operationId: verifyOrderPayment
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    - name: payment_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Payment ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - verification_status
            properties:
              verification_status:
                type: string
                enum:
                - verified
                - rejected
                - pending
              verification_notes:
                type: string
              verified_amount:
                type: number
                format: decimal
    responses:
      '200':
        description: Payment verification completed
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderPayment'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Production Tracking - Real-Time Progress Monitoring
/tenant/orders/{id}/production:
  get:
    tags:
    - Production Management
    summary: Get Production Status (Real-Time Tracking)
    description: 'Track production progress and milestones per PHASE_4_B production workflow.

      **Production Information**:
      - **Real-Time Status**: Current production stage with timestamp
      - **Milestone Tracking**:
        - Material prep: Raw materials sourcing and preparation
        - Design approval: Final design sign-off before production
        - Production start: Actual production begins
        - Half complete: 50% production milestone
        - Quality check: QA inspection in progress
        - Packaging: Final packaging and preparation
        - Ready ship: Approved and ready for shipment
      - **Progress Percentage**: 0-100% completion tracking
      - **Quality Checkpoints**: 
        - Pass/Fail status at each checkpoint
        - Quality issue documentation
        - Corrective action tracking
      - **Estimated Completion**:
        - Original estimate from vendor
        - Updated estimate based on progress
        - Risk assessment for delays
      - **Vendor Reports**:
        - Photo documentation of production stages
        - Issue/delay notifications
        - Special notes and comments
        - Delivery confirmation once complete
      '
    operationId: getProductionStatus
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: Production status retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/ProductionStatus'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  patch:
    tags:
    - Production Management
    summary: Update Production Progress
    description: 'Update production milestone and progress.

      **Progress Updates:**
      - Milestone completion tracking
      - Progress percentage updates
      - Quality checkpoint results
      - Issue and delay reporting
      - Photo documentation upload
      '
    operationId: updateProductionProgress
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              milestone:
                type: string
                enum:
                - material_prep
                - design_approval
                - production_start
                - half_complete
                - quality_check
                - packaging
                - ready_ship
              progress_percentage:
                type: integer
                minimum: 0
                maximum: 100
              notes:
                type: string
              issues:
                type: array
                items:
                  type: string
              photo_urls:
                type: array
                items:
                  type: string
                  format: uri
              estimated_completion:
                type: string
                format: date-time
    responses:
      '200':
        description: Production progress updated successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/ProductionStatus'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Shipping Management
/tenant/orders/{id}/shipment:
  post:
    tags:
    - Shipping Management
    summary: Create Shipment
    description: 'Create shipment and tracking information for completed order.

      **Shipment Creation:**
      - Courier selection and booking
      - Tracking number generation
      - Shipping documentation
      - Customer notification
      - Delivery estimation
      '
    operationId: createShipment
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - courier_name
            - shipping_method
            properties:
              courier_name:
                type: string
                description: Courier/shipping company name
              shipping_method:
                type: string
                enum:
                - regular
                - express
                - same_day
                - pickup
              tracking_number:
                type: string
                description: Tracking number from courier
              estimated_delivery:
                type: string
                format: date-time
              shipping_cost:
                type: number
                format: decimal
              notes:
                type: string
    responses:
      '201':
        description: Shipment created successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderShipment'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
  get:
    tags:
    - Shipping Management
    summary: Get Shipment Details
    description: 'Retrieve shipment tracking and delivery information.

      **Shipment Information:**
      - Current shipping status
      - Tracking number and carrier details
      - Delivery updates and location
      - Proof of delivery documents
      - Customer delivery confirmation
      '
    operationId: getShipmentDetails
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: Shipment details retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrderShipment'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Bulk Operations
/tenant/orders/bulk:
  post:
    tags:
    - Orders Management
    summary: Bulk Operations
    description: 'Perform bulk operations on multiple orders.

      **Bulk Operations:**
      - Status updates for multiple orders
      - Vendor assignment to multiple orders
      - Export order data to various formats
      - Mass email notifications
      '
    operationId: bulkOrderOperations
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - operation
            - order_ids
            properties:
              operation:
                type: string
                enum:
                - update_status
                - assign_vendor
                - export_data
                - send_notifications
              order_ids:
                type: array
                items:
                  type: string
                  format: uuid
              parameters:
                type: object
                description: Operation-specific parameters
    responses:
      '200':
        description: Bulk operation completed successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      processed_count:
                        type: integer
                      failed_count:
                        type: integer
                      errors:
                        type: array
                        items:
                          type: string
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'

# Admin Order Creation
/tenant/orders/admin:
  post:
    tags:
    - Customer Orders
    summary: Create Order (Admin)
    description: 'Create new order through admin interface with enhanced features.

      **Admin Capabilities:**
      - Create orders on behalf of customers
      - Set custom pricing and terms
      - Assign vendor during creation
      - Set priority and tags
      - Upload multiple design files
      '
    operationId: createOrderAdmin
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '../../components/schemas.yaml#/CreateOrderRequest'
    responses:
      '201':
        description: Order created successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PurchaseOrder'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Order Cancellation
/tenant/orders/{id}/cancel:
  delete:
    tags:
    - Orders Management
    summary: Cancel Order
    description: 'Cancel order with refund processing and audit trail.

      **Business Rules:**
      - Orders can only be cancelled in certain statuses
      - Paid orders require refund processing
      - Vendor orders require vendor notification
      - Complete audit trail maintained
      - Customer notification automatic
      '
    operationId: cancelOrder
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - reason
            properties:
              reason:
                type: string
                description: Cancellation reason
              notify_customer:
                type: boolean
                default: true
                description: Send cancellation notification to customer
              notify_vendor:
                type: boolean
                default: true
                description: Send cancellation notification to vendor
              refund_amount:
                type: number
                format: decimal
                description: Amount to refund
    responses:
      '200':
        description: Order cancelled successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PurchaseOrder'
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Shipment Management - List all shipments
/tenant/orders/{id}/shipments:
  get:
    tags:
    - Shipping Management
    summary: List Order Shipments
    description: 'Retrieve all shipments for order.

      **Shipment Information:**
      - Current shipping status for each shipment
      - Tracking numbers and carrier details
      - Delivery updates and location tracking
      - Proof of delivery documents
      - Shipment history
      '
    operationId: listOrderShipments
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    - name: status
      in: query
      schema:
        type: string
        enum:
        - pending
        - processing
        - in_transit
        - delivered
        - failed
      description: Filter by shipment status
    responses:
      '200':
        description: Shipments retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '../../components/schemas.yaml#/OrderShipment'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Profitability Analysis
/tenant/orders/{id}/profitability:
  get:
    tags:
    - Orders Management
    summary: Get Order Profitability Analysis
    description: 'Retrieve profitability metrics and margin analysis for order.

      **Profitability Metrics:**
      - Total revenue and cost breakdown
      - Gross and net profit calculations
      - Profit margin percentages
      - Cost comparison with vendor quotes
      - ROI analysis
      '
    operationId: getOrderProfitability
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order ID
    responses:
      '200':
        description: Profitability analysis retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      order_id:
                        type: string
                        format: uuid
                      customer_price:
                        type: number
                        format: decimal
                        description: Total price charged to customer
                      total_cost:
                        type: number
                        format: decimal
                        description: Total cost (vendor + overhead)
                      vendor_cost:
                        type: number
                        format: decimal
                        description: Vendor quoted price
                      overhead_cost:
                        type: number
                        format: decimal
                        description: Overhead/operational costs
                      gross_profit:
                        type: number
                        format: decimal
                        description: Gross profit (customer_price - vendor_cost)
                      net_profit:
                        type: number
                        format: decimal
                        description: Net profit (gross_profit - overhead)
                      profit_margin_percent:
                        type: number
                        format: decimal
                        description: Profit margin percentage
                      roi_percent:
                        type: number
                        format: decimal
                        description: Return on investment percentage
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Data Export
/tenant/orders/export:
  post:
    tags:
    - Orders Management
    summary: Export Orders Data
    description: 'Export order data in various formats for reporting and analysis.

      **Supported Formats:**
      - Excel (XLSX) with multiple sheets
      - CSV (comma-separated values)
      - PDF (formatted reports)
      - JSON (raw data export)

      **Filtering & Selection:**
      - Filter by status, date range, customer
      - Select specific fields to export
      - Group by customer, vendor, month
      - Include related data (payments, shipments, communications)
      '
    operationId: exportOrdersData
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - format
            properties:
              format:
                type: string
                enum:
                - excel
                - csv
                - pdf
                - json
                description: Export format
              filters:
                type: object
                description: Filter criteria (status, date_from, date_to, customer_id, vendor_id)
              fields:
                type: array
                items:
                  type: string
                description: Specific fields to include in export
              include_related:
                type: array
                items:
                  type: string
                  enum:
                  - payments
                  - shipments
                  - communications
                  - quotations
                description: Include related data in export
              group_by:
                type: string
                enum:
                - customer
                - vendor
                - status
                - month
                description: Group exported data by field
              filename:
                type: string
                description: Custom filename for export (without extension)
    responses:
      '200':
        description: Export data retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      download_url:
                        type: string
                        format: uri
                        description: URL to download export file
                      filename:
                        type: string
                        description: Generated filename
                      format:
                        type: string
                        description: Export format used
                      record_count:
                        type: integer
                        description: Number of records in export
                      file_size:
                        type: string
                        description: File size in bytes
                      expires_at:
                        type: string
                        format: date-time
                        description: Download URL expiration time
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '422':
        $ref: '../../components/schemas.yaml#/ValidationError'

# Analytics & Reports
/tenant/orders/analytics:
  get:
    tags:
    - Orders Analytics
    summary: Get Orders Analytics
    description: 'Retrieve comprehensive analytics and insights for orders.

      **Analytics Data:**
      - Order volume trends over time
      - Revenue analysis and forecasting
      - Customer behavior patterns
      - Production efficiency metrics
      - Vendor performance comparisons
      - Payment collection rates
      '
    operationId: getOrdersAnalytics
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: date_from
      in: query
      schema:
        type: string
        format: date
      description: Analytics start date
    - name: date_to
      in: query
      schema:
        type: string
        format: date
      description: Analytics end date
    - name: metrics
      in: query
      schema:
        type: array
        items:
          type: string
      style: form
      explode: false
      description: Specific metrics to include
    responses:
      '200':
        description: Analytics retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/OrdersAnalytics'
      '401':
        $ref: '../../components/schemas.yaml#/Unauthorized'
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
# Order Status Workflow - Enhanced Endpoints

# Advance Order Stage
/tenant/orders/{id}/advance-stage:
  post:
    tags:
    - Order Status Workflow
    summary: Advance Order Stage
    description: |
      Advances an order to a specific business stage with validation and requirement checking.
      
      **Business Workflow:**
      - Validates stage transition rules
      - Checks requirement completion
      - Updates order status and stage
      - Creates timeline entry
      - Sends notifications to stakeholders
      
      **Stage Progression:**
      - draft → pending → vendor_sourcing → vendor_negotiation → customer_quote → awaiting_payment → in_production → quality_control → shipping → delivered
      
      **Validation Rules:**
      - Cannot skip required stages
      - Must meet stage requirements
      - User must have advancement permissions
      - Order must be in valid state for transition
      
      **Vendor Negotiation → Customer Quote Validation:**
      When advancing from vendor_negotiation to customer_quote, the system validates:
      - At least one accepted vendor quote must exist
      - order.vendor_quoted_price must not be null
      - order.quotation_amount must not be null
      - order.vendor_id must not be null
      
      If validation fails, returns 422 error with message:
      "No accepted vendor quote found. Please accept a quote before proceeding to customer quote stage."
    operationId: advanceOrderStage
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order UUID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - action
            - target_stage
            - notes
            properties:
              action:
                type: string
                enum:
                - advance_stage
                description: Action type (always 'advance_stage')
              target_stage:
                type: string
                enum:
                - pending
                - vendor_sourcing
                - vendor_negotiation
                - customer_quote
                - awaiting_payment
                - partial_payment
                - full_payment
                - in_production
                - quality_control
                - shipping
                - delivered
                - cancelled
                - on_hold
                description: Target business stage
              notes:
                type: string
                minLength: 10
                maxLength: 500
                description: Notes explaining the stage advancement
              requirements:
                type: object
                additionalProperties:
                  type: boolean
                description: Requirements completion status
              metadata:
                type: object
                additionalProperties: true
                description: Additional metadata for the advancement
          examples:
            vendor_negotiation:
              summary: Advance to vendor negotiation
              value:
                action: advance_stage
                target_stage: vendor_negotiation
                notes: Vendor identified and initial contact made
                requirements:
                  vendor_identified: true
                  initial_quote_received: true
                metadata:
                  vendor_id: vendor-uuid
                  expected_completion: "2024-01-20"
            customer_quote:
              summary: Advance to customer quote (requires accepted vendor quote)
              value:
                action: advance_stage
                target_stage: customer_quote
                notes: Vendor quote accepted, ready to present to customer
                requirements:
                  vendor_quote_accepted: true
                  pricing_finalized: true
    responses:
      '200':
        description: Order stage advanced successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    $ref: '../../components/schemas.yaml#/PurchaseOrder'
                  next_steps:
                    type: array
                    items:
                      type: string
                    description: Suggested next actions
                  requirements_met:
                    type: object
                    additionalProperties:
                      type: boolean
                    description: Requirements completion status
      '400':
        description: Invalid stage transition
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  error:
                    type: object
                    properties:
                      code:
                        type: string
                        example: INVALID_STAGE_TRANSITION
                      message:
                        type: string
                        example: Cannot advance from vendor_sourcing to completed
                      details:
                        type: object
                        properties:
                          current_stage:
                            type: string
                          requested_stage:
                            type: string
                          missing_requirements:
                            type: array
                            items:
                              type: string
                  suggestions:
                    type: array
                    items:
                      type: string
                    description: Suggestions to resolve the issue
      '403':
        $ref: '../../components/schemas.yaml#/Forbidden'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'
      '422':
        description: Validation error - Stage advancement requirements not met
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  message:
                    type: string
                    example: "The given data was invalid."
                  errors:
                    type: object
                    properties:
                      vendor_negotiation:
                        type: array
                        items:
                          type: string
                        example: ["No accepted vendor quote found. Please accept a quote before proceeding to customer quote stage."]
            examples:
              vendor_quote_required:
                summary: Vendor quote not accepted
                value:
                  message: "The given data was invalid."
                  errors:
                    vendor_negotiation:
                      - "No accepted vendor quote found. Please accept a quote before proceeding to customer quote stage."
              missing_vendor_price:
                summary: Missing vendor pricing data
                value:
                  message: "The given data was invalid."
                  errors:
                    vendor_negotiation:
                      - "Order is missing vendor quoted price. Please ensure quote data is properly synced."

# Get Order Timeline (Enhanced)
/tenant/orders/{id}/timeline:
  get:
    tags:
    - Order Status Workflow
    summary: Get Order Timeline
    description: |
      Retrieves comprehensive timeline of order status changes and business events.
      
      **Timeline Events Include:**
      - Order creation and status changes
      - Stage advancements and completions
      - User notes and comments
      - System-generated events
      - Business milestone achievements
      - Stakeholder interactions
      
      **Event Categories:**
      - system: Automated system events
      - admin: Administrative actions
      - customer: Customer interactions
      - vendor: Vendor-related events
      - payment: Payment-related events
    operationId: getOrderTimeline
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order UUID
    - name: include_synthetic
      in: query
      schema:
        type: boolean
        default: true
      description: Include calculated timeline events
    - name: language
      in: query
      schema:
        type: string
        enum: [id, en]
        default: id
      description: Response language
    - name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 50
      description: Number of events to return
    - name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
      description: Pagination offset
    responses:
      '200':
        description: Order timeline retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      timeline:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              format: uuid
                            stage:
                              type: string
                            status:
                              type: string
                            timestamp:
                              type: string
                              format: date-time
                            actor:
                              type: string
                            actor_name:
                              type: string
                            notes:
                              type: string
                            metadata:
                              type: object
                              properties:
                                synthetic:
                                  type: boolean
                                category:
                                  type: string
                                  enum: [system, admin, customer, vendor, payment]
                                is_business_critical:
                                  type: boolean
                                event_type:
                                  type: string
                      pagination:
                        type: object
                        properties:
                          total:
                            type: integer
                          limit:
                            type: integer
                          offset:
                            type: integer
                          has_more:
                            type: boolean
                      summary:
                        type: object
                        properties:
                          total_events:
                            type: integer
                          business_critical_events:
                            type: integer
                          last_update:
                            type: string
                            format: date-time
                          current_stage:
                            type: string
                          days_in_current_stage:
                            type: integer
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Add Timeline Note
/tenant/orders/{id}/timeline/notes:
  post:
    tags:
    - Order Status Workflow
    summary: Add Timeline Note
    description: |
      Adds a note to the order timeline for a specific stage.
      
      **Use Cases:**
      - Document progress updates
      - Record communication with stakeholders
      - Note important decisions or changes
      - Track vendor interactions
      - Record quality control observations
    operationId: addTimelineNote
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order UUID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - stage
            - notes
            properties:
              stage:
                type: string
                description: Business stage for the note
              notes:
                type: string
                minLength: 10
                maxLength: 1000
                description: Note content
              metadata:
                type: object
                additionalProperties: true
                description: Additional metadata for the note
          examples:
            vendor_contact:
              summary: Vendor contact note
              value:
                stage: vendor_sourcing
                notes: Contacted 3 vendors, waiting for quotes
                metadata:
                  vendors_contacted: ["vendor1", "vendor2", "vendor3"]
                  expected_response: "2024-01-16"
                  priority: high
    responses:
      '201':
        description: Timeline note added successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      stage:
                        type: string
                      notes:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                      actor:
                        type: string
                      actor_name:
                        type: string
                      metadata:
                        type: object
      '400':
        $ref: '../../components/schemas.yaml#/BadRequest'
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Get Stage Requirements
/tenant/orders/{id}/stages/{stage}/requirements:
  get:
    tags:
    - Order Status Workflow
    summary: Get Stage Requirements
    description: |
      Retrieves requirements and validation status for advancing to a specific stage.
      
      **Requirements Types:**
      - Business rule requirements
      - Data completion requirements
      - Permission requirements
      - External dependency requirements
      
      **Validation Status:**
      - completed: Requirement is satisfied
      - pending: Requirement needs attention
      - blocked: Requirement cannot be completed yet
    operationId: getStageRequirements
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order UUID
    - name: stage
      in: path
      required: true
      schema:
        type: string
        enum:
        - pending
        - vendor_sourcing
        - vendor_negotiation
        - customer_quote
        - awaiting_payment
        - in_production
        - quality_control
        - shipping
        - delivered
      description: Target business stage
    responses:
      '200':
        description: Stage requirements retrieved successfully
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      stage:
                        type: string
                      requirements:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            label:
                              type: string
                            description:
                              type: string
                            completed:
                              type: boolean
                            required:
                              type: boolean
                            metadata:
                              type: object
                      can_advance:
                        type: boolean
                      next_stage:
                        type: string
                      estimated_completion_days:
                        type: integer
                      completion_percentage:
                        type: integer
                      blocking_requirements:
                        type: array
                        items:
                          type: string
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'

# Validate Stage Transition
/tenant/orders/{id}/validate-transition:
  post:
    tags:
    - Order Status Workflow
    summary: Validate Stage Transition
    description: |
      Validates whether a stage transition is allowed and provides detailed feedback.
      
      **Validation Checks:**
      - Business rule compliance
      - Requirement completion
      - User permissions
      - Order state validity
      - Dependency satisfaction
      
      **Response Information:**
      - Transition validity
      - Missing requirements
      - Warnings and suggestions
      - Impact assessment
    operationId: validateStageTransition
    security:
    - bearerAuth: []
    parameters:
    - $ref: '../../components/schemas.yaml#/TenantHeader'
    - name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Order UUID
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
            - from_stage
            - to_stage
            properties:
              from_stage:
                type: string
                description: Current stage
              to_stage:
                type: string
                description: Target stage
              user_permissions:
                type: array
                items:
                  type: string
                description: User permissions for validation
    responses:
      '200':
        description: Transition validation completed
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      valid:
                        type: boolean
                      can_advance:
                        type: boolean
                      missing_requirements:
                        type: array
                        items:
                          type: string
                      warnings:
                        type: array
                        items:
                          type: string
                      confirmation_required:
                        type: boolean
                      estimated_impact:
                        type: object
                        properties:
                          timeline_change:
                            type: string
                          cost_impact:
                            type: string
                          stakeholders_affected:
                            type: array
                            items:
                              type: string
                      next_actions:
                        type: array
                        items:
                          type: string
      '400':
        description: Invalid transition request
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../../components/schemas.yaml#/BaseResponse'
              - type: object
                properties:
                  data:
                    type: object
                    properties:
                      valid:
                        type: boolean
                        example: false
                      can_advance:
                        type: boolean
                        example: false
                      missing_requirements:
                        type: array
                        items:
                          type: string
                      errors:
                        type: array
                        items:
                          type: string
                      suggestions:
                        type: array
                        items:
                          type: string
      '404':
        $ref: '../../components/schemas.yaml#/NotFound'