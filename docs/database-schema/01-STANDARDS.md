# STANDARDS & CONVENTIONS
## Database and API Implementation Guidelines

**Module:** Core Standards  
**Version:** 1.0  
**Last Updated:** November 10, 2025

---

## OVERVIEW

Dokumen ini mendefinisikan standar dan konvensi yang digunakan di seluruh sistem Stencil CMS. Semua modul HARUS mengikuti standar ini untuk memastikan konsistensi dan maintainability.

---

## NAMING CONVENTIONS

### Database Field Naming

**Field Format:**
```
snake_case untuk database columns
camelCase untuk JSON API responses
```

**Examples:**
```sql
Database: created_at, user_id, publish_status
API JSON: createdAt, userId, publishStatus
```

### Status Fields

Gunakan nama status yang deskriptif sesuai konteks:

| Field Name | Usage | Values |
|------------|-------|--------|
| `status` | Generic status | `active`, `inactive`, `pending` |
| `publish_status` | Content publication | `draft`, `published`, `archived` |
| `payment_status` | Payment states | `unpaid`, `pending`, `paid`, `failed`, `refunded` |
| `approval_status` | Review workflows | `pending`, `approved`, `rejected` |
| `order_status` | Order processing | `pending`, `processing`, `completed`, `cancelled` |
| `shipping_status` | Delivery tracking | `pending`, `shipped`, `in_transit`, `delivered` |

### Date & Time Fields

**Standard Date Fields:**
```sql
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
deleted_at TIMESTAMP NULL  -- For soft deletes
published_at TIMESTAMP NULL  -- For content scheduling
```

**Usage Guidelines:**
- `created_at` - Auto-set on record creation (NEVER manually modified)
- `updated_at` - Auto-updated on any change via trigger (PostgreSQL doesn't support ON UPDATE)
- `deleted_at` - Only set when soft-deleting (NULL = active)
- `published_at` - Set when content goes live (can be future-dated)

**PostgreSQL Trigger for updated_at:**
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_{table_name}_updated_at
BEFORE UPDATE ON {table_name}
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### Boolean Fields

**Prefix Conventions:**

| Prefix | Usage | Examples |
|--------|-------|----------|
| `is_` | State checks | `is_active`, `is_featured`, `is_enabled`, `is_visible` |
| `has_` | Possession checks | `has_discount`, `has_stock`, `has_image`, `has_variations` |
| `can_` | Permission checks | `can_edit`, `can_delete`, `can_publish`, `can_comment` |
| `should_` | Behavior flags | `should_notify`, `should_index`, `should_cache` |

**Type:**
```sql
BOOLEAN DEFAULT TRUE/FALSE
```

### Relationship & Foreign Key Naming

**Foreign Keys:**
```sql
{table}_id  -- Points to id in {table}

Examples:
user_id BIGINT  -- References users.id
product_id BIGINT  -- References products.id
category_id BIGINT  -- References categories.id
```

**Pivot Tables:**
```sql
{table1}_{table2}  -- Alphabetically ordered

Examples:
product_category  -- Links products and categories
user_role  -- Links users and roles
tag_post  -- Links tags and posts (NOT post_tag)
```

**Polymorphic Relationships:**
```sql
{relationship}_type VARCHAR(255)  -- Model class name
{relationship}_id BIGINT  -- Model ID

Examples:
commentable_type  -- 'Product', 'Post', etc.
commentable_id  -- ID of the commented item

taggable_type
taggable_id

seo_metable_type  -- For universal SEO
seo_metable_id
```

---

## DATABASE STANDARDS

### Table Structure

**Required Fields for All Tables:**
```sql
CREATE TABLE example_table (
    -- Primary Key
    id BIGSERIAL PRIMARY KEY,
    
    -- Optional UUID for public-facing IDs
    uuid UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),
    
    -- Your table fields here
    -- ...
    
    -- Timestamps (REQUIRED)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_example_table_created_at ON example_table(created_at);
CREATE INDEX idx_example_table_deleted_at ON example_table(deleted_at);

-- Trigger for updated_at
CREATE TRIGGER update_example_table_updated_at
BEFORE UPDATE ON example_table
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### Primary Keys

**Standard:**
```sql
id BIGSERIAL PRIMARY KEY
-- Or alternatively:
id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY
```

**Never Use:**
- String primary keys (use UUID field instead)
- Composite primary keys (use unique indexes)
- Small integer types (use BIGINT for scalability)

### UUIDs for Public IDs

```sql
uuid UUID NOT NULL UNIQUE DEFAULT gen_random_uuid()
```

**Usage:**
- Auto-generated by PostgreSQL using `gen_random_uuid()` or on application level
- Use in URLs instead of integer IDs: `/products/{uuid}`
- Indexed for fast lookups
- Prevents ID enumeration attacks

### Foreign Key Constraints

**Standard Pattern:**
```sql
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
```

**Delete Actions:**
- `CASCADE` - Delete child records when parent deleted (e.g., order items when order deleted)
- `SET NULL` - Set to NULL when parent deleted (e.g., created_by when user deleted)
- `RESTRICT` - Prevent parent deletion if children exist (rarely used)

### Indexing Strategy

**Always Index:**
1. Foreign keys
2. Status fields
3. Date fields used in queries
4. Fields used in WHERE clauses
5. Fields used in ORDER BY
6. Polymorphic type+id combinations

**Index Types:**
```sql
-- Single column
CREATE INDEX idx_table_status ON table_name(status);

-- Multi-column (order matters!)
CREATE INDEX idx_table_user_status ON table_name(user_id, status);

-- Unique constraint
CREATE UNIQUE INDEX unique_table_email ON table_name(email);
-- Or as table constraint:
ALTER TABLE table_name ADD CONSTRAINT unique_table_email UNIQUE (email);

-- Full-text search (PostgreSQL uses GIN or GiST indexes)
CREATE INDEX idx_table_search ON table_name USING GIN(to_tsvector('english', title || ' ' || description));
```

**Index Naming:**
```
idx_{table}_{column}  -- Single column
idx_{table}_{col1}_{col2}  -- Multi-column
unique_{table}_{column}  -- Unique constraint
```

### Soft Deletes

**Implementation:**
```sql
deleted_at TIMESTAMP NULL,
INDEX idx_deleted_at (deleted_at)
```

**Query Patterns:**
```sql
-- Active records only
WHERE deleted_at IS NULL

-- Deleted records only
WHERE deleted_at IS NOT NULL

-- All records (including deleted)
-- No WHERE clause on deleted_at
```

### Character Set & Collation

**PostgreSQL Standard:**
```sql
-- PostgreSQL uses UTF-8 by default
-- Set at database creation:
CREATE DATABASE stencil_cms
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_US.UTF-8'
    LC_CTYPE = 'en_US.UTF-8';
```

**Reasoning:**
- PostgreSQL uses UTF-8 encoding by default (full Unicode support including emojis)
- Collation can be specified at database, table, or column level if needed
- All tables use ACID-compliant storage engine by default

---

## DATA TYPES

### String Types

| Type | Max Length | Usage |
|------|------------|-------|
| `VARCHAR(50)` | 50 chars | Short codes, slugs |
| `VARCHAR(100)` | 100 chars | Names, titles |
| `VARCHAR(255)` | 255 chars | Standard text fields |
| `VARCHAR(500)` | 500 chars | URLs, file paths |
| `TEXT` | Unlimited | Long text, descriptions, very long content |

### Numeric Types

| Type | Range | Usage |
|------|-------|-------|
| `SMALLINT` | -32768 to 32767 | Small numbers, ratings (0-255) |
| `INTEGER` or `INT` | -2B to 2B | Regular integers |
| `BIGINT` | -9 quintillion to 9 quintillion | IDs, large counts |
| `BIGSERIAL` | Auto-incrementing BIGINT | Auto-increment primary keys |
| `DECIMAL(10,2)` | 10 digits, 2 decimals | Money, prices |
| `DECIMAL(15,4)` | 15 digits, 4 decimals | Precise calculations |
| `NUMERIC` | Arbitrary precision | Alias for DECIMAL |

**Note:** PostgreSQL doesn't have UNSIGNED types. Use CHECK constraints if you need to enforce positive values:
```sql
price DECIMAL(10,2) CHECK (price >= 0)
quantity INT CHECK (quantity >= 0)
```

### Date & Time Types

| Type | Format | Usage |
|------|--------|-------|
| `DATE` | YYYY-MM-DD | Birth dates, deadlines |
| `DATETIME` | YYYY-MM-DD HH:MM:SS | Specific moments |
| `TIMESTAMP` | Same as DATETIME | Auto-updating timestamps |
| `TIME` | HH:MM:SS | Durations, time of day |
| `YEAR` | YYYY | Year only |

### JSON Type

```sql
options JSONB NULL
-- Or use JSON for exact text preservation (JSONB is faster and recommended)
metadata JSON NULL
```

**PostgreSQL JSON Types:**
- `JSONB` - Binary JSON, faster querying, supports indexing (recommended)
- `JSON` - Text-based JSON, preserves exact formatting

**Usage:**
- Form validation rules
- Dynamic configuration
- Flexible metadata
- Arrays of simple values

**Example:**
```json
{
  "minLength": 3,
  "maxLength": 100,
  "pattern": "^[a-zA-Z]+$",
  "required": true
}
```

**Indexing JSONB:**
```sql
CREATE INDEX idx_table_options ON table_name USING GIN(options);
```

### ENUM Type

**PostgreSQL supports custom ENUM types:**
```sql
-- Create custom type
CREATE TYPE status_type AS ENUM ('draft', 'published', 'archived');

-- Use in table
CREATE TABLE posts (
    id BIGSERIAL PRIMARY KEY,
    status status_type DEFAULT 'draft'
);
```

**Alternative: CHECK constraint (more flexible):**
```sql
CREATE TABLE posts (
    id BIGSERIAL PRIMARY KEY,
    status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived'))
);
```

**When to Use:**
- Fixed, small set of values (< 10 options)
- Values rarely change
- Values are business logic, not configuration

**When NOT to Use:**
- Values might change frequently (use CHECK constraint or lookup tables)
- Values should be configurable
- Large set of options
- Use lookup tables instead

**Note:** CHECK constraints are easier to modify than custom ENUM types in PostgreSQL.

---

## API STANDARDS

### Base URL Structure

```
Production:  https://api.stencilcms.com/api/v1
Staging:     https://staging-api.stencilcms.com/api/v1
Development: http://localhost:8000/api/v1
```

### Route Structure

**Public Routes:**
```
GET    /api/v1/pages/{slug}
GET    /api/v1/products
GET    /api/v1/products/{uuid}
POST   /api/v1/contact/submit
GET    /api/v1/faq/search
```

**Admin Routes:**
```
GET    /api/v1/admin/pages
POST   /api/v1/admin/pages
PUT    /api/v1/admin/pages/{id}
DELETE /api/v1/admin/pages/{id}
PATCH  /api/v1/admin/pages/{id}/publish
```

**Resource Pattern:**
```
GET    /api/v1/admin/{resource}           # List
POST   /api/v1/admin/{resource}           # Create
GET    /api/v1/admin/{resource}/{id}      # Show
PUT    /api/v1/admin/{resource}/{id}      # Update
DELETE /api/v1/admin/{resource}/{id}      # Delete
```

### Authentication

**Header:**
```http
Authorization: Bearer {access_token}
```

**Token Format:**
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
```

**Required For:**
- All `/admin/*` endpoints
- User-specific data
- Write operations (POST, PUT, DELETE)

**Not Required For:**
- Public content (pages, products)
- Search endpoints
- Static resources

### Standard Response Format

**Success Response:**
```json
{
  "success": true,
  "data": {
    // Response data here
  },
  "message": "Operation completed successfully",
  "meta": {
    "timestamp": "2025-01-01T12:00:00Z",
    "version": "1.0"
  }
}
```

**Error Response:**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "The given data was invalid",
    "details": {
      "email": ["The email field is required"],
      "name": ["The name must be at least 3 characters"]
    }
  },
  "meta": {
    "timestamp": "2025-01-01T12:00:00Z"
  }
}
```

**Paginated Response:**
```json
{
  "success": true,
  "data": [
    // Array of items
  ],
  "meta": {
    "pagination": {
      "current_page": 1,
      "per_page": 15,
      "total": 100,
      "last_page": 7,
      "from": 1,
      "to": 15
    }
  }
}
```

### HTTP Status Codes

| Code | Status | Usage |
|------|--------|-------|
| `200` | OK | Successful GET, PUT, PATCH |
| `201` | Created | Successful POST |
| `204` | No Content | Successful DELETE |
| `400` | Bad Request | Malformed request |
| `401` | Unauthorized | Missing/invalid auth token |
| `403` | Forbidden | Valid token, insufficient permissions |
| `404` | Not Found | Resource doesn't exist |
| `422` | Unprocessable Entity | Validation errors |
| `429` | Too Many Requests | Rate limit exceeded |
| `500` | Internal Server Error | Server error |

### Error Codes

**Standard Error Codes:**
```
VALIDATION_ERROR         - Input validation failed
AUTHENTICATION_REQUIRED  - No auth token provided
INVALID_TOKEN           - Auth token is invalid/expired
INSUFFICIENT_PERMISSION - User lacks required permission
RESOURCE_NOT_FOUND      - Requested resource doesn't exist
DUPLICATE_ENTRY         - Unique constraint violation
RATE_LIMIT_EXCEEDED     - Too many requests
SERVER_ERROR            - Internal server error
```

### Pagination

**Query Parameters:**
```
GET /api/v1/products?page=1&per_page=20&sort=created_at&order=desc
```

**Parameters:**
- `page` - Page number (default: 1)
- `per_page` - Items per page (default: 15, max: 100)
- `sort` - Sort field (default: `created_at`)
- `order` - Sort order: `asc` or `desc` (default: `desc`)

### Filtering

**Query Parameters:**
```
GET /api/v1/products?status=published&category_id=5&min_price=100
```

**Common Filters:**
- `status` - Filter by status
- `search` - Full-text search
- `date_from` - Start date (YYYY-MM-DD)
- `date_to` - End date (YYYY-MM-DD)
- `{field}_id` - Filter by relationship

### Rate Limiting

**Limits:**
- Public endpoints: 60 requests/minute
- Authenticated: 300 requests/minute
- Admin endpoints: 1000 requests/minute

**Headers:**
```http
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 45
X-RateLimit-Reset: 1640000000
```

---

## VALIDATION RULES

### Common Field Validations

**Email:**
```
required|email|max:255|unique:users,email
```

**Password:**
```
required|min:8|confirmed|regex:/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/
```

**URL:**
```
nullable|url|max:500
```

**Phone:**
```
nullable|regex:/^[\d\s\+\-\(\)]+$/|max:20
```

**Slug:**
```
required|alpha_dash|max:255|unique:pages,slug
```

**Status:**
```
required|in:draft,published,archived
```

---

## SECURITY STANDARDS

### Password Hashing

```php
// Use bcrypt with cost 12
password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);
```

### SQL Injection Prevention

- **ALWAYS** use prepared statements
- **NEVER** concatenate user input into SQL
- Use ORM query builders (Eloquent, Query Builder)

### XSS Prevention

- Sanitize HTML input
- Escape output
- Use Content Security Policy headers

### CSRF Protection

- Include CSRF token in forms
- Validate token on POST/PUT/DELETE
- Use SameSite cookies

### File Upload Security

- Validate file type (MIME + extension)
- Limit file size
- Store outside web root
- Rename uploaded files
- Scan for malware

---

## PERFORMANCE GUIDELINES

### Database Queries

**DO:**
- Use indexes for frequently queried fields
- Limit SELECT columns to what's needed
- Use eager loading to prevent N+1 queries
- Cache frequently accessed data
- Use database-level pagination

**DON'T:**
- SELECT * (specify columns)
- Query in loops (use batch queries)
- Run heavy queries without indexes
- Store large BLOBs in database (use file storage)

### API Responses

**DO:**
- Compress responses (gzip)
- Use HTTP caching headers
- Implement ETags
- Paginate large datasets
- Return only necessary fields

**DON'T:**
- Return entire database tables
- Include sensitive data unnecessarily
- Nest relationships too deeply
- Send uncompressed responses

---

## CODING STANDARDS

### SQL Style

```sql
-- Table names: plural, snake_case
CREATE TABLE user_profiles (
    -- Field names: snake_case, descriptive
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    
    -- Group related fields
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    
    -- Enums or CHECK constraints: lowercase, descriptive values
    gender VARCHAR(50) CHECK (gender IN ('male', 'female', 'other')),
    
    -- Comments for complex fields
    preferences JSONB NULL,
    
    -- Timestamps last
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Foreign keys
    CONSTRAINT fk_user_profiles_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Comments on columns
COMMENT ON COLUMN user_profiles.preferences IS 'User preference settings';

-- Indexes
CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
CREATE INDEX idx_user_profiles_created_at ON user_profiles(created_at);

-- Trigger for updated_at
CREATE TRIGGER update_user_profiles_updated_at
BEFORE UPDATE ON user_profiles
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### API Documentation

```yaml
# Use OpenAPI/Swagger format
paths:
  /api/v1/products:
    get:
      summary: List all products
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductList'
```

---

## MIGRATION GUIDELINES

### Creating Migrations

**Naming:**
```
YYYY_MM_DD_HHMMSS_create_table_name_table.php
2025_01_01_120000_create_users_table.php
2025_01_01_120001_add_status_to_users_table.php
```

**Structure:**
```php
public function up()
{
    Schema::create('users', function (Blueprint $table) {
        $table->id();
        $table->uuid('uuid')->unique();
        $table->string('email')->unique();
        $table->timestamp('email_verified_at')->nullable();
        $table->string('password');
        $table->rememberToken();
        $table->timestamps();
        $table->softDeletes();
    });
}

public function down()
{
    Schema::dropIfExists('users');
}
```

---

## TESTING STANDARDS

### Database Testing

```php
// Use factories for test data
$user = User::factory()->create();
$product = Product::factory()->count(10)->create();

// Use database transactions
use RefreshDatabase;

// Assert database state
$this->assertDatabaseHas('users', ['email' => 'test@example.com']);
```

### API Testing

```php
// Test endpoints
$response = $this->getJson('/api/v1/products');
$response->assertStatus(200);
$response->assertJsonStructure([
    'success',
    'data' => [
        '*' => ['id', 'name', 'price']
    ]
]);
```

---

## DOCUMENTATION REQUIREMENTS

### Code Comments

**Database:**
```sql
-- Comment for complex fields
preferences JSON NULL COMMENT 'User notification preferences: {email: bool, sms: bool}'
```

**API:**
```php
/**
 * Update product details
 * 
 * @param  Request $request
 * @param  int $id
 * @return JsonResponse
 */
public function update(Request $request, $id)
```

### README Files

Every module should include:
1. Purpose & overview
2. Installation steps
3. Configuration options
4. Usage examples
5. API endpoints
6. Testing instructions

---

**Next:** [02-HOMEPAGE.md](./02-HOMEPAGE.md) - Homepage/Beranda Module
